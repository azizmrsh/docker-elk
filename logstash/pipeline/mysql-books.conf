# ===================================================================
# ملف إعدادات خط معالجة بيانات MySQL للكتب
# ===================================================================
# هذا الملف مخصص لاستيراد بيانات الكتب وصفحاتها من قاعدة بيانات MySQL
# إلى Elasticsearch لتمكين البحث والفهرسة
# ===================================================================

# ===================================================================
# قسم المدخلات - اتصال قاعدة البيانات (Input - Database Connection)
# ===================================================================
input {
  # ===================================================================
  # مدخل JDBC لقاعدة بيانات MySQL
  # ===================================================================
  jdbc {
    # مسار مكتبة تعريف MySQL JDBC Driver
    jdbc_driver_library => "/usr/share/logstash/drivers/mysql-connector-j-8.0.33.jar"
    
    # فئة تعريف MySQL Driver
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    
    # سلسلة الاتصال بقاعدة البيانات مع المعاملات الأمنية
    # useSSL=false: تعطيل SSL للاتصال المحلي
    # allowPublicKeyRetrieval=true: السماح باسترداد المفتاح العام
    # characterEncoding=UTF-8: ترميز UTF-8 لدعم النصوص العربية
    jdbc_connection_string => "jdbc:mysql://145.223.98.97:3306/bms?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=UTF-8"
    
    # بيانات اعتماد قاعدة البيانات
    jdbc_user => "bms"          # اسم المستخدم
    jdbc_password => "bms2025"  # كلمة المرور
    
    # ===================================================================
    # استعلام SQL لاستخراج بيانات صفحات الكتب
    # ===================================================================
    # استعلام بسيط للاختبار - صفحات مع كتبها المرتبطة
    statement => "
      SELECT 
        p.id as page_id,              -- معرف الصفحة الفريد
        p.book_id,                    -- معرف الكتاب المرتبط
        p.page_number,                -- رقم الصفحة في الكتاب
        p.content,                    -- محتوى الصفحة (النص)
        b.title as book_title,        -- عنوان الكتاب
        'Unknown Author' as author_name,  -- اسم المؤلف (افتراضي)
        p.updated_at                  -- تاريخ آخر تحديث
      FROM pages p
      INNER JOIN books b ON p.book_id = b.id  -- ربط الصفحات بالكتب
      WHERE p.content IS NOT NULL              -- التأكد من وجود محتوى
        AND p.content != ''                    -- التأكد من عدم كون المحتوى فارغ
        AND CHAR_LENGTH(p.content) > 10        -- التأكد من وجود محتوى كافي
        AND (:sql_last_value IS NULL OR p.updated_at > :sql_last_value)  -- المزامنة التدريجية
      ORDER BY p.updated_at ASC                -- ترتيب حسب تاريخ التحديث
       LIMIT 500                              -- حد أقصى 500 سجل لكل دفعة (محسن للأداء)
    "
    
    # ===================================================================
    # إعدادات الجدولة والمزامنة (Scheduling & Synchronization)
    # ===================================================================
    # جدولة التشغيل كل 5 دقائق لتقليل الحمل على قاعدة البيانات
     schedule => "*/5 * * * *"  # تنسيق Cron: كل 5 دقائق
    
    # ===================================================================
    # تتبع آخر تحديث للمزامنة التدريجية
    # ===================================================================
    use_column_value => true                    # استخدام قيمة عمود لتتبع التحديثات
    tracking_column => "updated_at"             # العمود المستخدم للتتبع
    tracking_column_type => "timestamp"         # نوع البيانات للعمود
    last_run_metadata_path => "/usr/share/logstash/data/.logstash_jdbc_last_run_pages"  # مسار حفظ آخر تشغيل
    
    # ===================================================================
    # إعدادات الترميز والنوع
    # ===================================================================
    charset => "UTF-8"      # ترميز الأحرف لدعم النصوص العربية
    type => "book_page"     # نوع البيانات لتمييز هذا المدخل
  }
}

# ===================================================================
# قسم المرشحات - معالجة وتحويل البيانات (Filter Section)
# ===================================================================
filter {
  # معالجة البيانات فقط إذا كان النوع "book_page"
  if [type] == "book_page" {
    # ===================================================================
    # معالجة أساسية للفهرسة السريعة
    # ===================================================================
    mutate {
      remove_field => ["@version"]    # إزالة حقل الإصدار غير المطلوب
      
      # تحويل أنواع البيانات للحقول المهمة
      convert => { 
        "page_id" => "string"         # معرف الصفحة كنص
        "book_id" => "string"         # معرف الكتاب كنص
        "page_number" => "integer"    # رقم الصفحة كرقم صحيح
      }
    }
    
    # ===================================================================
    # إنشاء حقول قابلة للبحث للنصوص العربية
    # ===================================================================
    mutate {
      # إنشاء حقل نص قابل للبحث
      add_field => { "search_text" => "%{content}" }
      # إنشاء عنوان وصفي للوثيقة
      add_field => { "document_title" => "%{book_title} - صفحة %{page_number}" }
    }
    
    # ===================================================================
    # معالجة تاريخ التحديث فقط
    # ===================================================================
    if [updated_at] {
      date {
        match => [ "updated_at", "yyyy-MM-dd HH:mm:ss" ]  # تنسيق التاريخ المتوقع
        target => "updated_at"                              # الحقل المستهدف
      }
    }
  }
}

# ===================================================================
# قسم المخرجات - إرسال البيانات إلى Elasticsearch (Output Section)
# ===================================================================
output {
  # إرسال البيانات فقط إذا كان النوع "book_page"
  if [type] == "book_page" {
    # ===================================================================
    # مخرج Elasticsearch لفهرسة صفحات الكتب
    # ===================================================================
    elasticsearch {
      hosts => ["elasticsearch:9200"]              # عناوين خوادم Elasticsearch
      user => "logstash_internal"                   # اسم المستخدم للمصادقة
      password => "${LOGSTASH_INTERNAL_PASSWORD}"   # كلمة المرور من متغير البيئة
      index => "book-pages-%{+YYYY.MM}"             # اسم الفهرس منظم حسب الشهر
      document_id => "%{page_id}"                   # معرف الوثيقة الفريد (لتجنب التكرار)
    }
  }
}
